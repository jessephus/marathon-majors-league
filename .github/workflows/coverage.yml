name: Test Coverage

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'lib/**'
      - 'components/**'
      - 'tests/**'
      - 'pages/**'
      - '.c8rc.json'
      - 'package.json'
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage
        run: npm run test:coverage:new
        continue-on-error: true
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: test
      
      - name: Generate coverage summary
        id: coverage
        run: |
          # Generate coverage summary from json-summary
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const total = data.total;
              console.log(JSON.stringify({
                lines: total.lines.pct.toFixed(2),
                statements: total.statements.pct.toFixed(2),
                functions: total.functions.pct.toFixed(2),
                branches: total.branches.pct.toFixed(2)
              }));
            ")
            
            LINES=$(echo $COVERAGE | node -e "console.log(JSON.parse(require('fs').readFileSync(0, 'utf-8')).lines)")
            STATEMENTS=$(echo $COVERAGE | node -e "console.log(JSON.parse(require('fs').readFileSync(0, 'utf-8')).statements)")
            FUNCTIONS=$(echo $COVERAGE | node -e "console.log(JSON.parse(require('fs').readFileSync(0, 'utf-8')).functions)")
            BRANCHES=$(echo $COVERAGE | node -e "console.log(JSON.parse(require('fs').readFileSync(0, 'utf-8')).branches)")
            
            echo "lines=$LINES" >> $GITHUB_OUTPUT
            echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
            echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
            echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          else
            echo "lines=0" >> $GITHUB_OUTPUT
            echo "statements=0" >> $GITHUB_OUTPUT
            echo "functions=0" >> $GITHUB_OUTPUT
            echo "branches=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const lines = '${{ steps.coverage.outputs.lines }}';
            const statements = '${{ steps.coverage.outputs.statements }}';
            const functions = '${{ steps.coverage.outputs.functions }}';
            const branches = '${{ steps.coverage.outputs.branches }}';
            
            const linesEmoji = lines >= 70 ? 'âœ…' : lines >= 59 ? 'âš ï¸' : 'âŒ';
            const statementsEmoji = statements >= 70 ? 'âœ…' : statements >= 59 ? 'âš ï¸' : 'âŒ';
            const functionsEmoji = functions >= 60 ? 'âœ…' : functions >= 38 ? 'âš ï¸' : 'âŒ';
            const branchesEmoji = branches >= 70 ? 'âœ…' : branches >= 61 ? 'âš ï¸' : 'âŒ';
            
            const allTargetsMet = lines >= 70 && statements >= 70 && functions >= 60 && branches >= 70;
            const baselinesMet = lines >= 59 && statements >= 59 && functions >= 38 && branches >= 61;
            const statusMessage = allTargetsMet 
              ? 'ğŸ‰ **All coverage targets met!**' 
              : baselinesMet 
              ? 'âœ… **Baseline coverage maintained** - targets are stretch goals for future improvement'
              : 'âŒ **Coverage below baseline** - please add tests to maintain at least 59% lines, 38% functions, 61% branches';
            
            const comment = [
              '## ğŸ“Š Test Coverage Report',
              '',
              '| Metric | Coverage | Status | Target |',
              '|--------|----------|--------|--------|',
              '| Lines | ' + lines + '% | ' + linesEmoji + ' | 59% (baseline) / 70% (target) |',
              '| Statements | ' + statements + '% | ' + statementsEmoji + ' | 59% (baseline) / 70% (target) |',
              '| Functions | ' + functions + '% | ' + functionsEmoji + ' | 38% (baseline) / 60% (target) |',
              '| Branches | ' + branches + '% | ' + branchesEmoji + ' | 61% (baseline) / 70% (target) |',
              '',
              '**Scope:** New modules in lib/ and components/ directories',
              '',
              '### Coverage Requirements',
              '',
              '**Baseline (Required):**',
              '- âœ… **59% lines** - prevents regression',
              '- âœ… **38% functions** - maintains current level',
              '- âœ… **61% branches** - ensures critical paths tested',
              '',
              '**Targets (Stretch Goals):**',
              '- ğŸ¯ **70% lines** - aligns with industry standards',
              '- ğŸ¯ **60% functions** - improved function coverage',
              '- ğŸ¯ **70% branches** - better edge case coverage',
              '',
              statusMessage,
              '',
              '<details>',
              '<summary>ğŸ“‹ Tested Modules</summary>',
              '',
              '- lib/state-manager.ts',
              '- lib/state-provider.tsx',
              '- lib/dynamic-import.ts',
              '- lib/performance-monitor.ts',
              '- lib/feature-flags.ts',
              '- components/LeaderboardTable.tsx',
              '- components/ResultsTable.tsx',
              '- components/Footer.tsx',
              '',
              '</details>',
              '',
              '---',
              '*Generated by test coverage workflow â€¢ [View full report](../actions)*'
            ].join('\n');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
      
      - name: Check coverage thresholds
        run: |
          LINES="${{ steps.coverage.outputs.lines }}"
          STATEMENTS="${{ steps.coverage.outputs.statements }}"
          FUNCTIONS="${{ steps.coverage.outputs.functions }}"
          BRANCHES="${{ steps.coverage.outputs.branches }}"
          
          echo "ğŸ“Š Coverage Results:"
          echo "  Lines: $LINES%"
          echo "  Statements: $STATEMENTS%"
          echo "  Functions: $FUNCTIONS%"
          echo "  Branches: $BRANCHES%"
          
          # Check thresholds (allowing for floating point comparison)
          EXIT_CODE=0
          
          if (( $(echo "$LINES < 59" | bc -l) )); then
            echo "âŒ Lines coverage ($LINES%) below 59% baseline"
            EXIT_CODE=1
          fi
          
          if (( $(echo "$STATEMENTS < 59" | bc -l) )); then
            echo "âŒ Statements coverage ($STATEMENTS%) below 59% baseline"
            EXIT_CODE=1
          fi
          
          if (( $(echo "$FUNCTIONS < 38" | bc -l) )); then
            echo "âŒ Functions coverage ($FUNCTIONS%) below 38% baseline"
            EXIT_CODE=1
          fi
          
          if (( $(echo "$BRANCHES < 61" | bc -l) )); then
            echo "âŒ Branches coverage ($BRANCHES%) below 61% baseline"
            EXIT_CODE=1
          fi
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… All baseline coverage thresholds met!"
            
            # Check stretch goals (informational only)
            if (( $(echo "$LINES >= 70" | bc -l) )) && (( $(echo "$FUNCTIONS >= 60" | bc -l) )) && (( $(echo "$BRANCHES >= 70" | bc -l) )); then
              echo "ğŸ‰ Stretch goal targets achieved!"
            else
              echo "â„¹ï¸  Baseline met. Stretch goals (70/60/70) are future targets."
            fi
          else
            exit $EXIT_CODE
          fi
