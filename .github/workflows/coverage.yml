name: Test Coverage

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'lib/**'
      - 'components/**'
      - 'tests/**'
      - 'pages/**'
      - '.c8rc.json'
      - 'package.json'
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage
        run: npm run test:coverage:new
        continue-on-error: true
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: test
      
      - name: Generate coverage summary
        id: coverage
        run: |
          # Generate coverage summary from json-summary
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const total = data.total;
              console.log(JSON.stringify({
                lines: total.lines.pct.toFixed(2),
                statements: total.statements.pct.toFixed(2),
                functions: total.functions.pct.toFixed(2),
                branches: total.branches.pct.toFixed(2)
              }));
            ")
            
            LINES=$(echo $COVERAGE | node -e "console.log(JSON.parse(require('fs').readFileSync(0, 'utf-8')).lines)")
            STATEMENTS=$(echo $COVERAGE | node -e "console.log(JSON.parse(require('fs').readFileSync(0, 'utf-8')).statements)")
            FUNCTIONS=$(echo $COVERAGE | node -e "console.log(JSON.parse(require('fs').readFileSync(0, 'utf-8')).functions)")
            BRANCHES=$(echo $COVERAGE | node -e "console.log(JSON.parse(require('fs').readFileSync(0, 'utf-8')).branches)")
            
            echo "lines=$LINES" >> $GITHUB_OUTPUT
            echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
            echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
            echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          else
            echo "lines=0" >> $GITHUB_OUTPUT
            echo "statements=0" >> $GITHUB_OUTPUT
            echo "functions=0" >> $GITHUB_OUTPUT
            echo "branches=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const lines = '${{ steps.coverage.outputs.lines }}';
            const statements = '${{ steps.coverage.outputs.statements }}';
            const functions = '${{ steps.coverage.outputs.functions }}';
            const branches = '${{ steps.coverage.outputs.branches }}';
            
            const linesEmoji = lines >= 90 ? '‚úÖ' : lines >= 80 ? '‚ö†Ô∏è' : '‚ùå';
            const statementsEmoji = statements >= 90 ? '‚úÖ' : statements >= 80 ? '‚ö†Ô∏è' : '‚ùå';
            const functionsEmoji = functions >= 90 ? '‚úÖ' : functions >= 80 ? '‚ö†Ô∏è' : '‚ùå';
            const branchesEmoji = branches >= 85 ? '‚úÖ' : branches >= 75 ? '‚ö†Ô∏è' : '‚ùå';
            
            const allTargetsMet = lines >= 90 && statements >= 90 && functions >= 90 && branches >= 85;
            const statusMessage = allTargetsMet ? 'üéâ **All coverage targets met!**' : '‚ö†Ô∏è **Some coverage targets not met** - please add tests';
            
            const comment = [
              '## üìä Test Coverage Report',
              '',
              '| Metric | Coverage | Status | Target |',
              '|--------|----------|--------|--------|',
              '| Lines | ' + lines + '% | ' + linesEmoji + ' | 90% |',
              '| Statements | ' + statements + '% | ' + statementsEmoji + ' | 90% |',
              '| Functions | ' + functions + '% | ' + functionsEmoji + ' | 90% |',
              '| Branches | ' + branches + '% | ' + branchesEmoji + ' | 85% |',
              '',
              '**Scope:** New modules in lib/ and components/ directories',
              '',
              '### Coverage Requirements (Issue #82)',
              '',
              'New modules must meet these thresholds:',
              '- ‚úÖ **90% lines** coverage',
              '- ‚úÖ **90% functions** coverage',
              '- ‚úÖ **85% branches** coverage',
              '',
              statusMessage,
              '',
              '<details>',
              '<summary>üìã Tested Modules</summary>',
              '',
              '- lib/state-manager.ts',
              '- lib/state-provider.tsx',
              '- lib/dynamic-import.ts',
              '- lib/performance-monitor.ts',
              '- lib/feature-flags.ts',
              '- components/LeaderboardTable.tsx',
              '- components/ResultsTable.tsx',
              '- components/Footer.tsx',
              '',
              '</details>',
              '',
              '---',
              '*Generated by test coverage workflow ‚Ä¢ [View full report](../actions)*'
            ].join('\n');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
      
      - name: Check coverage thresholds
        run: |
          LINES="${{ steps.coverage.outputs.lines }}"
          STATEMENTS="${{ steps.coverage.outputs.statements }}"
          FUNCTIONS="${{ steps.coverage.outputs.functions }}"
          BRANCHES="${{ steps.coverage.outputs.branches }}"
          
          echo "üìä Coverage Results:"
          echo "  Lines: $LINES%"
          echo "  Statements: $STATEMENTS%"
          echo "  Functions: $FUNCTIONS%"
          echo "  Branches: $BRANCHES%"
          
          # Check thresholds (allowing for floating point comparison)
          if (( $(echo "$LINES < 90" | bc -l) )); then
            echo "‚ùå Lines coverage ($LINES%) below 90% threshold"
            exit 1
          fi
          
          if (( $(echo "$STATEMENTS < 90" | bc -l) )); then
            echo "‚ùå Statements coverage ($STATEMENTS%) below 90% threshold"
            exit 1
          fi
          
          if (( $(echo "$FUNCTIONS < 90" | bc -l) )); then
            echo "‚ùå Functions coverage ($FUNCTIONS%) below 90% threshold"
            exit 1
          fi
          
          if (( $(echo "$BRANCHES < 85" | bc -l) )); then
            echo "‚ùå Branches coverage ($BRANCHES%) below 85% threshold"
            exit 1
          fi
          
          echo "‚úÖ All coverage thresholds met!"
